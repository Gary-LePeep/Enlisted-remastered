<!doctype html>
<html>

<head>
    <title>Enlisted Tool</title>
    <script>
        const LANGUAGE = '{{language}}'
    </script>
</head>

<body style="background-color:rgb(39, 55, 61);"></body>

<script src="../static/common.js"></script>
<script src="../static/datamine/weapons-meta.js"></script>


<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="../static/fetch.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"
    integrity="sha256-eTyxS0rkjpLEo16uXTS0uVCS4815lc40K2iVpWDvdSY=" crossorigin="anonymous"></script>


<body>
    <script>
        // TITLE BAR
        BODY.appendChild(translate('page.datamine.title', 'b', 'position: absolute; top:0px; left:115px; font-family: Trebuchet MS; width:1000px; font-size:50px; color: white; text-align:center;'));
        addButtons('datamine');

        WEAPONS_JSON = readJSON('{{weaponsJson}}')

        function createWeaponStatsDiv(top, left, name) {
            const div = document.createElement('div');
            div.style = `position: absolute; top: ${80 + top}px; left: ${500 + left}px; width: 400px;`;
            BODY.append(div);
            const divTextbox = document.createElement('img');
            divTextbox.src = '../static/img/textBox.png';
            divTextbox.style = 'position: absolute; height: 35px; width: 400px;';
            div.appendChild(divTextbox);
            const divTitle = document.createElement('b');
            divTitle.style = 'position: absolute; top: 5px; width: 400px; text-align: center; font-size:20px; font-family: Trebuchet MS; color: white;';
            divTitle.innerHTML = name;
            div.append(divTitle);
            return div;
        }

        function createWeaponRow(top, name, div) {
            const label = document.createElement('div');
            label.innerHTML = translate(name);
            label.style = `position: absolute; top: ${40 + top}px; left: 40px; color: white`;
            div.append(label);
            const data = document.createElement('b');
            data.innerHTML = '-';
            label.append(data);
            return data;
        }

        // General data
        metaDiv = createWeaponStatsDiv(0, 0, translate('page.datamine.metadata.header'));
        const gunNameData = createWeaponRow(0, 'page.datamine.gunName', metaDiv);
        const gunIGNData = createWeaponRow(20, 'page.datamine.gunIGN', metaDiv);
        const akaData = createWeaponRow(40, 'page.datamine.aka', metaDiv);
        const typeData = createWeaponRow(60, 'page.datamine.type', metaDiv);
        const weightData = createWeaponRow(80, 'page.datamine.weight', metaDiv);
        const firingModeData = createWeaponRow(100, 'page.datamine.firingMode', metaDiv);
        const zeroDistanceData = createWeaponRow(120, 'page.datamine.zeroDistance', metaDiv);
        

        // Bullets data
        bulletsDiv = createWeaponStatsDiv(200, 0, translate('page.datamine.bullets.header'));
        const magazineNameData = createWeaponRow(0, 'page.datamine.magazineName', bulletsDiv);
        const magazineSizeData = createWeaponRow(20, 'page.datamine.magazineSize', bulletsDiv);
        const ammoData = createWeaponRow(40, 'page.datamine.ammo', bulletsDiv);
        const rpmData = createWeaponRow(60, 'page.datamine.rpm', bulletsDiv);
        const effRangeData = createWeaponRow(80, 'page.datamine.effRange', bulletsDiv);
        const maxRangeData = createWeaponRow(100, 'page.datamine.maxRange', bulletsDiv);
        const bulletSpeedData = createWeaponRow(120, 'page.datamine.bulletSpeed', bulletsDiv);

        // Dispersion & Recoil data
        disRecDiv = createWeaponStatsDiv(400, 0, translate('page.datamine.dispersionRecoil.header'));
        const dispersionData = createWeaponRow(0, 'page.datamine.dispersion', disRecDiv);
        const recoilVertData = createWeaponRow(20, 'page.datamine.recoilVert', disRecDiv);
        const recoilHorizData = createWeaponRow(40, 'page.datamine.recoilHoriz', disRecDiv);
        const crawlRecoilData = createWeaponRow(60, 'page.datamine.crawlRecoil', disRecDiv);

        // Reload data
        reloadDiv = createWeaponStatsDiv(540, 0, translate('page.datamine.reload.header'));
        const singleReloadPrepareData = createWeaponRow(0, 'page.datamine.singleReloadPrepare', reloadDiv);
        const singleReloadLoopData = createWeaponRow(20, 'page.datamine.singleReloadLoop', reloadDiv);
        const singleReloadPostData = createWeaponRow(40, 'page.datamine.singleReloadPost', reloadDiv);
        const reloadData = createWeaponRow(60, 'page.datamine.reload', reloadDiv);
        const reloadAltData = createWeaponRow(80, 'page.datamine.reloadAlt', reloadDiv);
        const reloadDualMagData = createWeaponRow(100, 'page.datamine.reloadDualMag', reloadDiv);

        // Accessories data
        accessoriesDiv = createWeaponStatsDiv(720, 0, translate('page.datamine.accessories.header'));
        const sightsMagData = createWeaponRow(0, 'page.datamine.sightsMag', accessoriesDiv);

        //Disclaimer
        BODY.append(translate('page.datamine.disclaimer', 'div', 'position: absolute; top: 870px; left: 10px; color: white; font-size:14px; font-family: Trebuchet MS;'));

        // Color Dropdown
        const primary = document.createElement('nav');
        primary.style = 'position: absolute; top: 65px'
        BODY.append(primary);

        const primarylist = document.createElement('ul');
        primary.append(primarylist);
        const colorButtonContainer = document.createElement('li');
        primarylist.append(colorButtonContainer);

        const colorButton = document.createElement('li');
        colorButton.className = 'topbtn greenbtn';
        colorButtonContainer.append(colorButton);

        const colorButtonText = document.createElement('a');
        colorButtonText.style = 'color: white; font-size:22px';
        colorButtonText.text = translate('Weapon');
        colorButton.append(colorButtonText);

        const categorylist = document.createElement('ul');
        colorButton.append(categorylist);

        // For each category
        for (let i = -1; i < WEAPONS_META.length; i++) {
            const categoryButton = document.createElement('li');
            categoryButton.className = 'submenu';
            categorylist.append(categoryButton);

            const categoryButtonText = document.createElement('a');
            categoryButtonText.text = i < 0 ? translate('Remove') : WEAPONS_META[i]['Category'];
            categoryButton.append(categoryButtonText);

            categoryButton.onclick = () => {
                // Click does nothing unless you're clicking on 'Remove' or you clicked on a weapon in a submenu
                if (window.newWeaponClicked || categoryButtonText.text === translate('Remove')) {
                    // reset color button
                    colorButtonText.text = translate('Weapon')
                    gunNameData.textContent = '-';
                    gunIGNData.textContent = '-';
                    akaData.textContent = '-';
                    typeData.textContent = '-';
                    ammoData.textContent = '-';
                    rpmData.textContent = '-';
                    effRangeData.textContent = '-';
                    maxRangeData.textContent = '-';
                    bulletSpeedData.textContent = '-';
                    tableRow1.textContent = '';
                    tableRow2.textContent = '';
                    tableRow3.textContent = '';
                    tableRow4.textContent = '';
                    tableRow5.textContent = '';
                    tableRow6.textContent = '';
                    dispersionData.textContent = '-';
                    singleReloadPrepareData.textContent = '-';
                    singleReloadLoopData.textContent = '-';
                    singleReloadPostData.textContent = '-';
                    zeroDistanceData.textContent = '-';
                    recoilVertData.textContent = '-';
                    recoilHorizData.textContent = '-';
                    reloadData.textContent = '-';
                    reloadAltData.textContent = '-';
                    reloadDualMagData.textContent = '-';
                    crawlRecoilData.textContent = '-';
                    sightsMagData.textContent = '-';
                    weightData.textContent = '-';
                    firingModeData.textContent = '-';
                    magazineNameData.textContent = '-';
                    magazineSizeData.textContent = '-';

                    if (window.refreshStars) {
                        starsDropdown.textContent = '';
                        starsDropdown.append(defaultOption);
                    }

                    window.newWeaponClicked = false;
                }
            }

            // Add all weapons to category
            const weaponlist = document.createElement('ul');
            categoryButton.append(weaponlist);

            for (let j = 0; i >= 0 && j < WEAPONS_META[i].Weapons.length; j++) {
                const weaponButton = document.createElement('li');
                weaponButton.className = 'link submenu';
                weaponlist.append(weaponButton);

                const weaponButtonText = document.createElement('a');
                weaponButtonText.text = WEAPONS_META[i].Weapons[j];
                weaponButton.append(weaponButtonText);

                weaponButton.onclick = () => {
                    window.newWeaponClicked = true;
                    categoryButton.onclick();

                    // set color button name to selected weapon
                    colorButtonText.text = translate(WEAPONS_META[i].Weapons[j]);
                    gunNameData.textContent = translate(WEAPONS_META[i].Weapons[j]);
                    gunIGNData.textContent = WEAPONS_META[i].Weapons[j]['Name Game'];

                    // Data for gun not entered yet
                    if (gunIGNData.textContent === '') {
                        gunIGNData.textContent = translate('NotFound');
                        return;
                    }
                    if (window.stalingrad_mode) {
                        gunIGNData.textContent = `stl_${gunIGNData.textContent}`;
                    }

                    akaData.textContent = getDataProperty([gunIGNData.textContent], 'gun__locName');
                    const wepType = getDataProperty([gunIGNData.textContent], 'item__weapType');
                    typeData.textContent = wepType.replace(/_/g, ' ');

                    // this gun simply does not exist. Return.
                    if (wepType === '-') {
                        return;
                    }

                    // create stars only on weapon change
                    if (window.refreshStars) {
                        starsDropdown.textContent = '';
                        for (let k = 0; k < STARUPGRADES[wepType].length; k++) {
                            starsDropdown.append(translate('★'.repeat(k + 1), 'option'));
                        }
                    }

                    // Apply star modifiers
                    let damageStar = 1;
                    let dispersionStar = 1;
                    let rpmStar = 1;
                    let recoilVertStar = 1;
                    let recoilHorizStar = 1;
                    let reloadStar = 1;

                    const stars = document.getElementById('starsDropdown').value.split('★').length - 2;
                    for (let k = stars; k >= 0; k--) {
                        const effects = Object.keys(STARUPGRADES[wepType][k]);
                        for (let l = 0; l < effects.length; l++) {
                            if (effects[l] === 'damage') {
                                damageStar *= STARUPGRADES[wepType][k][effects[l]];
                            } else if (effects[l] === 'dev') {
                                dispersionStar *= STARUPGRADES[wepType][k][effects[l]];
                            } else if (effects[l] === 'rpm') {
                                rpmStar *= STARUPGRADES[wepType][k][effects[l]];
                            } else if (effects[l] === 'recoilVert') {
                                recoilVertStar *= STARUPGRADES[wepType][k][effects[l]];
                            } else if (effects[l] === 'recoilHoriz') {
                                recoilHorizStar *= STARUPGRADES[wepType][k][effects[l]];
                            } else if (effects[l] === 'reload') {
                                reloadStar *= STARUPGRADES[wepType][k][effects[l]];
                            } else {
                                // eslint-disable-next-line no-alert
                                alert(`${effects[l]} , ${STARUPGRADES[wepType][k][effects[l]]}`);
                            }
                        }
                    }

                    weightData.textContent = getDataProperty([gunIGNData.textContent], 'item__weight');
                    weightData.textContent += weightData.textContent === '-' ? '' : translate('kg');
                    const firingModes = getDataProperty([gunIGNData.textContent], 'gun__firingModeNames:array');
                    if (Array.isArray(firingModes)) {
                        firingModeData.textContent = translate(firingModes[0].mode);
                        for (let k = 1; k < firingModes.length; k++) {
                            firingModeData.textContent += `, ${translate(firingModes[k].mode)}`;
                        }
                    } else {
                        firingModeData.textContent = translate(firingModes.mode);
                    }
                    rpmData.textContent = getDataProperty([gunIGNData.textContent], 'gun__shotFreq');
                    if (rpmData.textContent !== '-') {
                        let lowRPM = getDataProperty([gunIGNData.textContent], 'gun__shotFreqRndK');
                        const highRPM = (rpmData.textContent * 60 * rpmStar);
                        lowRPM = highRPM / (1 + lowRPM);
                        rpmData.textContent = `${toPlace(lowRPM, 2)} - ${toPlace(highRPM, 2)}`
                            + `(${translate('average')}${toPlace((highRPM + lowRPM) / 2, 2)})`;
                    }

                    dispersionData.textContent = toPlace(getDataProperty([gunIGNData.textContent], 'gun_spread__maxDeltaAngle')
                        * dispersionStar, 2);
                    zeroDistanceData.textContent = getDataProperty([gunIGNData.textContent], 'gun__zeroingDistance');
                    singleReloadPrepareData.textContent = getDataProperty([gunIGNData.textContent], 'single_reload__prepareTime');
                    singleReloadPrepareData.textContent = singleReloadPrepareData.textContent === '-'
                        ? '-' : toPlace(singleReloadPrepareData.textContent * reloadStar, 2);
                    singleReloadLoopData.textContent = getDataProperty([gunIGNData.textContent], 'single_reload__loopTime');
                    singleReloadLoopData.textContent = singleReloadLoopData.textContent === '-'
                        ? '-' : toPlace(singleReloadLoopData.textContent * reloadStar, 2);
                    singleReloadPostData.textContent = getDataProperty([gunIGNData.textContent], 'single_reload__postTime');
                    singleReloadPostData.textContent = singleReloadPostData.textContent === '-'
                        ? '-' : toPlace(singleReloadPostData.textContent * reloadStar, 2);
                    reloadData.textContent = getDataProperty([gunIGNData.textContent], 'gun__reloadTime');
                    reloadData.textContent = reloadData.textContent === '-' ? '-' : toPlace(reloadData.textContent * reloadStar, 2);
                    if (getDataProperty([gunIGNData.textContent], 'reload__singleBullet:tag') !== '-') {
                        reloadData.textContent = `[${reloadData.textContent}]`;
                        reloadData.style.setProperty('text-decoration', 'line-through');
                    }
                    reloadAltData.textContent = getDataProperty([gunIGNData.textContent], 'gun__altReloadTime');
                    reloadAltData.textContent = reloadAltData.textContent === '-'
                        ? '-' : toPlace(reloadAltData.textContent * reloadStar, 2);
                    reloadDualMagData.textContent = getDataProperty([gunIGNData.textContent], 'gun__dualMagReloadTime');
                    reloadDualMagData.textContent = reloadDualMagData.textContent === '-'
                        ? '-' : toPlace(reloadDualMagData.textContent * reloadStar, 2);
                    sightsMagData.textContent = getDataProperty([gunIGNData.textContent], 'gun__magnification');
                    sightsMagData.textContent += sightsMagData.textContent === '-' ? '' : '×';

                    const recoilTotal = getDataProperty([gunIGNData.textContent], 'gun__recoilAmount');
                    const recoilDir = getDataProperty([gunIGNData.textContent], 'gun__recoilDirAmount');
                    recoilVertData.textContent = toPlace(recoilTotal * 1000 * recoilDir * recoilVertStar, 2);
                    recoilHorizData.textContent = toPlace(recoilTotal * 1000 * (1 - recoilDir) * recoilHorizStar, 2);
                    crawlRecoilData.textContent = getDataProperty([gunIGNData.textContent], 'gun__crawlRecoilMult');
                    crawlRecoilData.textContent = crawlRecoilData.textContent === '-' ? '-' : `${crawlRecoilData.textContent * 100}%`;

                    ammoFile = getDataProperty([gunIGNData.textContent], 'gun__shells:array').shells.split('/');
                    ammoFile = ammoFile[ammoFile.length - 1];
                    [ammoData.textContent] = ammoFile.split('.');
                    for (let k = 1; k < ammoFile.split('.').length - 1; k++) {
                        ammoData.textContent += `.${ammoFile.split('.')[k]}`;
                    }

                    const ammoDataFile = window[`_${ammoData.textContent.replace(/\./g, '_')}`];

                    const magazineStat = getDataProperty([gunIGNData.textContent], 'gun__ammoHolders:array');
                    magazineNameData.textContent = Array.isArray(magazineStat)
                        ? magazineStat[0].ammoHolders : magazineStat.ammoHolders;
                    magazineSizeData.textContent = ALLITEMSDATA[magazineNameData.textContent].ammo_holder__ammoCount;

                    // damage just for flamethrowers done here
                    const flameDamage = getDataProperty([gunIGNData.textContent], 'flamethrower__streamDamagePerSecond');
                    if (flameDamage !== '-') {
                        const tableheader = document.createElement('th');
                        tableheader.textContent = translate('upTo')
                            + getDataProperty([gunIGNData.textContent], 'flamethrower__maxFlameLength') + translate('meters');
                        tableRow1.append(tableheader);
                        const tabledata = document.createElement('td');
                        tabledata.textContent = flameDamage + translate('perSecond');
                        tableRow2.append(tabledata);
                    }

                    // if ammo not found, return to prevent errors
                    if (ammoDataFile == null) {
                        return;
                    }
                    effRangeData.textContent = getAmmoProperty(ammoDataFile, 'effectiveDistance');
                    maxRangeData.textContent = getAmmoProperty(ammoDataFile, 'maxDistance');
                    bulletSpeedData.textContent = getAmmoProperty(ammoDataFile, 'speed');

                    // damage
                    const numBullets = getAmmoProperty(ammoDataFile, 'spawn');
                    const hitpower = getAmmoProperty(ammoDataFile, 'hitpower');
                    if (hitpower != null) {
                        const keys = Object.keys(hitpower);
                        const hitmult = getDataProperty([gunIGNData.textContent], 'gun__kineticDamageMult');

                        for (let k = 0; k < keys.length; k++) {
                            const tableheader = document.createElement('th');
                            tableheader.textContent = hitpower[keys[k]][1] + translate('meters');
                            tableRow1.append(tableheader);
                            const tabledata = document.createElement('td');
                            tabledata.textContent = '';
                            if (numBullets != null) {
                                if (numBullets.minCount === numBullets.maxCount) {
                                    tabledata.textContent += `${numBullets.maxCount} × `;
                                } else {
                                    tabledata.textContent += `(${numBullets.minCount} - ${numBullets.maxCount}) × `;
                                }
                            }
                            tabledata.textContent += toPlace(hitpower[keys[k]][0] * getAmmoProperty(ammoDataFile, 'hitPowerMult')
                                * damageStar * (hitmult === '-' ? 1 : hitmult), 3);
                            tableRow2.append(tabledata);
                        }
                    }
                    const cumDamage = getAmmoProperty(ammoDataFile, 'cumulativeDamage');
                    if (cumDamage != null) {
                        // damage on contact to vehicles
                        let tableheader = document.createElement('th');
                        tableheader.textContent = translate('contactVehicle');
                        tableRow5.append(tableheader);
                        let tabledata = document.createElement('td');
                        tabledata.textContent = cumDamage.damage;
                        tableRow6.append(tabledata);

                        // damage at distance to people
                        tableheader = document.createElement('th');
                        tableheader.textContent = `0${translate('meters')}`;
                        tableRow1.append(tableheader);
                        tabledata = document.createElement('td');
                        tabledata.textContent = getAmmoProperty(ammoDataFile, 'explodeHitPower');
                        tableRow2.append(tabledata);

                        tableheader = document.createElement('th');
                        tableheader.textContent = cumDamage.distance + translate('meters');
                        tableRow1.append(tableheader);
                        tabledata = document.createElement('td');
                        tabledata.textContent = 0;
                        tableRow2.append(tabledata);

                        // armor
                        tableheader = document.createElement('th');
                        tableheader.textContent = translate('contactVehicle');
                        tableRow3.append(tableheader);
                        tabledata = document.createElement('td');
                        tabledata.textContent = cumDamage.armorPower + translate('millimeters');
                        tableRow4.append(tabledata);
                    } else {
                        const armorpower = getAmmoProperty(ammoDataFile, 'armorpower');
                        if (armorpower != null) {
                            const keys = Object.keys(armorpower);
                            for (let k = 0; k < keys.length; k++) {
                                const tableheader = document.createElement('th');
                                tableheader.textContent = getAmmoProperty(ammoDataFile, 'armorpower')[keys[k]][1] + translate('meters');
                                tableRow3.append(tableheader);
                                const tabledata = document.createElement('td');
                                tabledata.textContent = (getAmmoProperty(ammoDataFile, 'armorpower')[keys[k]][0])
                                    + translate('millimeters');
                                tableRow4.append(tabledata);
                            }
                        }
                    }
                    window.refreshStars = true;
                };
            }
        }
    </script>
</body>

</html>